<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Firebase Auth — Minimal test</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f8fafc;color:#0f172a}
    main{max-width:640px;margin:40px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{border:1px solid #0ea5e9;background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .ghost{background:#fff;color:#0ea5e9}
    code{background:#f1f5f9;padding:2px 6px;border-radius:6px}
    #log{white-space:pre-wrap;font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#334155;margin-top:8px}
  </style>
</head>
<body>
  <main>
    <h1>Firebase Auth — Minimal test</h1>

    <div class="card">
      <div class="row"><strong>Holat:</strong> <span id="state">Boshlanmoqda…</span></div>
      <div class="row" style="margin-top:10px">
        <button id="btnSignIn"  class="btn">Google bilan kirish</button>
        <button id="btnSignOut" class="btn ghost" style="display:none">Chiqish</button>
      </div>
      <hr style="margin:12px 0;border:none;border-top:1px dashed #cbd5e1">
      <div><strong>Foydalanuvchi:</strong> <code id="who">—</code></div>
      <div id="log"></div>
    </div>

    <p style="margin-top:16px;color:#64748b">
      <strong>Eslatma:</strong> Agar bu sahifa ishlamasa, quyidagilarni tekshiring:
      Authorized domains (Netlify domeningiz), Google provider Enabled, API key to‘g‘ri loyihaniki, va sahifa <code>https</code> da.
    </p>
  </main>

  <!-- BARCHASI BITTA MODUL BLOKDA -->
  <script type="module">
    // ---- Firebase CDN importlari
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, GoogleAuthProvider,
      signInWithRedirect, getRedirectResult, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp }
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // ---- CONFIG (MathCenter). Xohlasangiz o'zingizning project config'ni qo'ying.
    const firebaseConfig = {
      apiKey: "AIzaSyAfoJhkSOqGvKWsIvGCi-OZ0sK2qLrnaGE",
      authDomain: "mathcenter-1c98d.firebaseapp.com",
      projectId: "mathcenter-1c98d",
      storageBucket: "mathcenter-1c98d.appspot.com",
      messagingSenderId: "1016417719928",
      appId: "1:1016417719928:web:700b028da1312477c87f8d",
      measurementId: "G-JEECME5HMJ"
    };

    // ---- UI yordamchilari
    const $ = (s)=>document.querySelector(s);
    const logDiv = $("#log");
    const log = (...a)=>{ console.log(...a); logDiv.textContent += a.map(x=>typeof x==="object"?JSON.stringify(x):String(x)).join(" ") + "\n"; };

    // ---- Init
    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence).catch(e=>log("[setPersistence]", e.code||e.message));
    auth.useDeviceLanguage?.();

    // ---- Redirect natijasini ko'rish (xatolar ko'rinsin)
    getRedirectResult(auth)
      .then(cred => { if (cred?.user) log("[redirect OK]", cred.user.email); })
      .catch(e => { alert("Kirish xatosi: " + (e.code || e.message)); log("[redirect error]", e); });

    // ---- Auth holati
    onAuthStateChanged(auth, async (user) => {
      log("[state]", Boolean(user), user?.email || "");
      if (user) {
        $("#state").textContent = "Kirdingiz";
        $("#who").textContent   = user.email || user.uid;
        $("#btnSignIn").style.display  = "none";
        $("#btnSignOut").style.display = "inline-flex";

        // ixtiyoriy: profil hujjati bor-yo'qligini tekshiramiz
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          await setDoc(ref, {
            uid: user.uid,
            email: user.email || null,
            createdAtFS: serverTimestamp()
          }, { merge: true });
          log("[profile] created");
        } else {
          log("[profile] exists");
        }
      } else {
        $("#state").textContent = "Chiqib turibsiz";
        $("#who").textContent   = "—";
        $("#btnSignIn").style.display  = "inline-flex";
        $("#btnSignOut").style.display = "none";
      }
    });

    // ---- Tugmalar
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    $("#btnSignIn").addEventListener("click", (e)=>{
      e.preventDefault();
      signInWithRedirect(auth, provider);
    });
    $("#btnSignOut").addEventListener("click", async ()=>{
      try { await signOut(auth); } catch(e){ alert("Chiqishda xato: " + (e.code||e.message)); }
    });
  </script>
</body>
</html>
